{% extends 'base.html' %}  {% block title %}| Appointments{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>Appointments</h4>

  <form class="row g-2" method="get" action="{{ url_for('main.admin_appointments') }}">
    <div class="col-auto">
      <input type="text" name="q" class="form-control form-control-sm" placeholder="Search patient or doctor" value="{{ request.args.get('q','') }}">
    </div>
    <div class="col-auto">
      <select name="status" class="form-select form-select-sm">
        <option value="">All status</option>
        <option value="Booked" {% if request.args.get('status')=='Booked' %}selected{% endif %}>Booked</option>
        <option value="Completed" {% if request.args.get('status')=='Completed' %}selected{% endif %}>Completed</option>
        <option value="Cancelled" {% if request.args.get('status')=='Cancelled' %}selected{% endif %}>Cancelled</option>
      </select>
    </div>
    <div class="col-auto">
      <input type="date" name="date" class="form-control form-control-sm" value="{{ request.args.get('date','') }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-sm btn-primary" type="submit">Filter</button>
      <a href="{{ url_for('main.admin_appointments') }}" class="btn btn-sm btn-outline-secondary">Reset</a>
    </div>
  </form>
</div>

<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead class="table-dark">
      <tr>
        <th>#</th>
        <th>Patient</th>
        <th>Doctor</th>
        <th>Department</th>
        <th>Date</th>
        <th>Time</th>
        <th>Status</th>
        <th>Created</th>
        <th class="text-end">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for a in appointments %}
      <tr id="appt-row-{{ a.id }}">
        <td>{{ a.id }}</td>
        <td>
          <a href="{{ url_for('main.view_patient', patient_id=a.patient.id) }}">
            {{ a.patient.user.name }}
          </a>
        </td>
        <td>
          <a href="{{ url_for('main.view_doctor', doctor_id=a.doctor.id) }}">
            {{ a.doctor.user.name }}
          </a>
          <div class="text-muted small">{{ a.doctor.specialization }}</div>
        </td>
        <td class="small text-muted">
          {% if a.doctor.department %}{{ a.doctor.department.name }}{% else %}—{% endif %}
        </td>
        <td>{{ a.date.isoformat() }}</td>
        <td>{{ a.time.strftime('%H:%M') }}</td>
        <td>
          {% if a.status == 'Booked' %}
            <span class="badge bg-info text-dark">Booked</span>
          {% elif a.status == 'Completed' %}
            <span class="badge bg-success">Completed</span>
          {% elif a.status == 'Cancelled' %}
            <span class="badge bg-secondary">Cancelled</span>
          {% else %}
            <span class="badge bg-warning text-dark">{{ a.status }}</span>
          {% endif %}
        </td>
        <td class="small text-muted">{{ a.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        <td class="text-end">
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('main.doctor_dashboard') }}#appt-{{ a.id }}" title="View details">
            View
          </a>

          {# Mark Completed (POST) #}
          {% if a.status != 'Completed' %}
          <form method="post" action="{{ url_for('main.admin_mark_completed', appt_id=a.id) }}"
                class="d-inline-block ms-1" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button class="btn btn-sm btn-success" title="Mark Completed">Complete</button>
          </form>
          {% endif %}

          {# Cancel appointment (POST) #}
          {% if a.status != 'Cancelled' and a.status != 'Completed' %}
          <form method="post" action="{{ url_for('main.admin_cancel_appointment', appt_id=a.id) }}"
                class="d-inline-block ms-1" style="display:inline;"
                onsubmit="event.preventDefault(); showDeleteModal('appointment','{{ a.patient.user.name }} - {{ a.date.isoformat() }}', this);">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button class="btn btn-sm btn-warning" title="Cancel Appointment">Cancel</button>
          </form>
          {% endif %}

          {# Delete appointment (soft-delete / or hard-delete depending on backend) #}
          <form method="post" action="{{ url_for('main.admin_delete_appointment', appt_id=a.id) }}"
                class="d-inline-block ms-1" style="display:inline;"
                onsubmit="event.preventDefault(); showDeleteModal('appointment','{{ a.id }}', this);">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button class="btn btn-sm btn-danger" title="Delete">Delete</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="9" class="text-center text-muted">No appointments found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{# Pagination placeholder (if you add pagination logic in the route) #}
{% if pagination %}
<nav aria-label="Page navigation">
  <ul class="pagination">
    {% if pagination.has_prev %}
    <li class="page-item"><a class="page-link" href="{{ url_for('main.admin_appointments', page=pagination.prev_num) }}">Previous</a></li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}
    {% for p in pagination.iter_pages() %}
      {% if p %}
        <li class="page-item {% if p == pagination.page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('main.admin_appointments', page=p) }}">{{ p }}</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">…</span></li>
      {% endif %}
    {% endfor %}
    {% if pagination.has_next %}
    <li class="page-item"><a class="page-link" href="{{ url_for('main.admin_appointments', page=pagination.next_num) }}">Next</a></li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<!-- fallback modal script: if showDeleteModal isn't available, confirm then submit -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  // If showDeleteModal not present, wire fallback confirm behavior for inline forms
  if (typeof showDeleteModal === 'undefined') {
    document.querySelectorAll('form[onsubmit]').forEach(f => {
      const handler = f.getAttribute('onsubmit');
      if (handler && handler.includes('showDeleteModal')) {
        f.addEventListener('submit', function (ev) {
          ev.preventDefault();
          const typeMatch = handler.match(/showDeleteModal\('([^']+)'/);
          const nameMatch = handler.match(/,\s*'([^']+)'/);
          const type = typeMatch ? typeMatch[1] : 'item';
          const name = nameMatch ? nameMatch[1] : '';
          if (confirm('Are you sure you want to delete ' + type + ' ' + name + '?')) {
            f.submit();
          }
        });
      }
    });
  }
});
</script>

{% endblock %}
